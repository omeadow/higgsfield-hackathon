<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>#higgsfield Creator Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #1a1a2e; }

    :root {
      --accent: #667eea;
      --accent-light: rgba(102,126,234,0.15);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .header {
      background: var(--gradient);
      color: white; padding: 24px 32px;
    }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header p { opacity: 0.85; margin-top: 4px; font-size: 14px; }

    .stats-bar {
      display: flex; gap: 16px; padding: 20px 32px; background: white;
      border-bottom: 1px solid #e4e6eb; flex-wrap: wrap;
    }
    .stat-card {
      flex: 1; min-width: 120px; padding: 16px; background: #f8f9fb;
      border-radius: 10px; text-align: center;
    }
    .stat-card .value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .stat-card .label { font-size: 11px; color: #65676b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    .controls {
      display: flex; gap: 12px; padding: 16px 32px; align-items: center; flex-wrap: wrap;
    }
    .controls input {
      flex: 1; min-width: 200px; padding: 10px 16px; border: 1px solid #ddd;
      border-radius: 8px; font-size: 14px; outline: none;
    }
    .controls input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .controls select {
      padding: 10px 16px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 14px; background: white; cursor: pointer;
    }

    .filter-chips {
      display: flex; gap: 8px; padding: 0 32px 8px; flex-wrap: wrap;
    }
    .chip {
      padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
      cursor: pointer; border: 1px solid #ddd; background: white; transition: all 0.2s;
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); }
    .chip.active { background: var(--accent); color: white; border-color: var(--accent); }
    .chip .count { font-size: 11px; opacity: 0.7; margin-left: 4px; }

    .grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px; padding: 16px 32px 32px;
    }

    .card {
      background: white; border-radius: 12px; overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); transform: translateY(-2px); }

    .card-header {
      display: flex; align-items: center; gap: 14px; padding: 20px;
    }
    .avatar {
      width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
      border: 3px solid var(--accent); flex-shrink: 0;
    }
    .avatar-fallback {
      width: 60px; height: 60px; border-radius: 50%; background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 24px; font-weight: 700; flex-shrink: 0;
    }
    .avatar-small {
      width: 36px; height: 36px; border-radius: 50%; object-fit: cover;
      border: 2px solid var(--accent); flex-shrink: 0;
    }
    .avatar-fallback-small {
      width: 36px; height: 36px; border-radius: 50%; background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 14px; font-weight: 700; flex-shrink: 0;
    }
    .card-identity { flex: 1; min-width: 0; }
    .card-identity .username {
      font-size: 15px; font-weight: 600; color: var(--accent);
      text-decoration: none; display: inline-flex; align-items: center; gap: 4px;
    }
    .card-identity .username:hover { text-decoration: underline; }
    .verified-badge {
      display: inline-block; width: 16px; height: 16px; background: var(--accent);
      border-radius: 50%; color: white; font-size: 10px; text-align: center;
      line-height: 16px;
    }
    .card-identity .fullname { font-size: 13px; color: #65676b; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-identity .category { font-size: 11px; color: #8b5cf6; margin-top: 2px; }

    .tier-badge {
      display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 10px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 6px;
    }
    .tier-macro { background: #fef3c7; color: #92400e; }
    .tier-mid-tier { background: #dbeafe; color: #1e40af; }
    .tier-micro { background: #d1fae5; color: #065f46; }
    .tier-nano { background: #f3e8ff; color: #6b21a8; }

    .niche-tags { padding: 0 20px 10px; display: flex; flex-wrap: wrap; gap: 4px; }
    .niche-tag {
      display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px;
      background: #f0f2f5; color: #65676b; font-weight: 500;
    }

    .campaign-dot {
      display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 6px;
      vertical-align: middle;
    }
    .dot-not_contacted { background: #9ca3af; }
    .dot-contacted { background: #f59e0b; }
    .dot-confirmed { background: #3b82f6; }
    .dot-content_posted { background: #10b981; }

    .card-bio {
      padding: 0 20px 14px; font-size: 13px; color: #444; line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
    }

    .card-stats {
      display: flex; border-top: 1px solid #f0f0f0; padding: 0;
    }
    .card-stat {
      flex: 1; text-align: center; padding: 14px 8px;
      border-right: 1px solid #f0f0f0;
    }
    .card-stat:last-child { border-right: none; }
    .card-stat .num { font-size: 16px; font-weight: 700; color: #1a1a2e; }
    .card-stat .lbl { font-size: 11px; color: #65676b; text-transform: uppercase; margin-top: 2px; }

    .empty { text-align: center; padding: 60px 32px; color: #65676b; font-size: 16px; }

    .tabs {
      display: flex; gap: 0; background: white; border-bottom: 2px solid #e4e6eb;
      padding: 0 32px;
    }
    .tab {
      padding: 14px 24px; font-size: 14px; font-weight: 600; color: #65676b;
      cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;
      transition: color 0.2s;
    }
    .tab:hover { color: var(--accent); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .methodology {
      max-width: 760px; margin: 32px auto; padding: 0 32px;
    }
    .methodology h2 { font-size: 22px; font-weight: 700; margin-bottom: 20px; color: #1a1a2e; }
    .methodology h3 { font-size: 16px; font-weight: 600; margin: 24px 0 10px; color: #1a1a2e; }
    .methodology p { font-size: 15px; line-height: 1.7; color: #444; margin-bottom: 12px; }
    .formula-box {
      background: linear-gradient(135deg, var(--accent-light), var(--accent-light));
      border: 1px solid var(--accent); border-radius: 10px; opacity: 0.85;
      padding: 24px; text-align: center; margin: 20px 0;
    }
    .formula-box .formula { font-size: 18px; font-weight: 700; color: var(--accent); font-family: monospace; }
    .formula-box .formula-note { font-size: 13px; color: #65676b; margin-top: 8px; }
    .scale-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    .scale-table th, .scale-table td {
      padding: 10px 16px; text-align: left; border-bottom: 1px solid #e4e6eb; font-size: 14px;
    }
    .scale-table th { font-weight: 600; color: #65676b; font-size: 12px; text-transform: uppercase; }
    .scale-table .rate { font-weight: 700; color: var(--accent); }
    .note-box {
      background: #fff8e6; border: 1px solid #f0d060; border-radius: 8px;
      padding: 16px; margin: 20px 0; font-size: 14px; line-height: 1.6; color: #6b5900;
    }

    /* Revenue Projections */
    .revenue-container {
      max-width: 900px; margin: 32px auto; padding: 0 32px;
    }
    .revenue-container h2 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
    .calc-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
    }
    .calc-panel {
      background: white; border-radius: 12px; padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .calc-panel h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1a1a2e; }
    .input-group { margin-bottom: 16px; }
    .input-group label {
      display: block; font-size: 13px; font-weight: 500; color: #65676b; margin-bottom: 6px;
    }
    .input-group input[type="number"],
    .input-group input[type="range"] {
      width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 14px; outline: none;
    }
    .input-group input[type="range"] { padding: 0; margin-top: 4px; }
    .input-group .range-value { font-size: 14px; font-weight: 600; color: var(--accent); float: right; }
    .input-group input[type="number"]:focus { border-color: var(--accent); }
    .output-row {
      display: flex; justify-content: space-between; padding: 12px 0;
      border-bottom: 1px solid #f0f0f0; font-size: 14px;
    }
    .output-row:last-child { border-bottom: none; }
    .output-row .out-label { color: #65676b; }
    .output-row .out-value { font-weight: 700; color: #1a1a2e; }
    .output-row .out-value.revenue { color: #10b981; font-size: 18px; }
    .progress-container { margin-top: 16px; }
    .progress-bar-bg {
      width: 100%; height: 24px; background: #f0f2f5; border-radius: 12px; overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%; background: linear-gradient(90deg, var(--accent), #10b981);
      border-radius: 12px; transition: width 0.3s; min-width: 0;
    }
    .progress-label {
      display: flex; justify-content: space-between; font-size: 12px; color: #65676b; margin-top: 4px;
    }
    .scenario-buttons {
      display: flex; gap: 8px; margin-bottom: 20px;
    }
    .scenario-btn {
      flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white;
      font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .scenario-btn:hover { border-color: var(--accent); color: var(--accent); }
    .scenario-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* Campaign Tracker */
    .campaign-container {
      max-width: 1200px; margin: 24px auto; padding: 0 32px;
    }
    .campaign-container h2 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
    .pipeline-stats {
      display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;
    }
    .pipeline-stat {
      flex: 1; min-width: 150px; padding: 16px; background: white; border-radius: 10px;
      text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .pipeline-stat .ps-value { font-size: 28px; font-weight: 700; }
    .pipeline-stat .ps-label { font-size: 12px; color: #65676b; text-transform: uppercase; margin-top: 4px; }
    .pipeline-stat .ps-pct { font-size: 11px; color: var(--accent); margin-top: 2px; }
    .ps-not_contacted .ps-value { color: #9ca3af; }
    .ps-contacted .ps-value { color: #f59e0b; }
    .ps-confirmed .ps-value { color: #3b82f6; }
    .ps-content_posted .ps-value { color: #10b981; }

    .pipeline-columns {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;
    }
    .pipeline-col {
      background: #f8f9fb; border-radius: 12px; padding: 16px; min-height: 200px;
    }
    .pipeline-col-header {
      font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e4e6eb;
      display: flex; justify-content: space-between; align-items: center;
    }
    .pipeline-col-header .col-count {
      background: #e4e6eb; padding: 2px 8px; border-radius: 10px; font-size: 12px;
    }
    .pipeline-card {
      background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06); cursor: pointer; transition: box-shadow 0.2s;
    }
    .pipeline-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
    .pipeline-card-row { display: flex; align-items: center; gap: 8px; }
    .pipeline-card .pc-info { flex: 1; min-width: 0; }
    .pipeline-card .pc-username { font-size: 13px; font-weight: 600; color: var(--accent); }
    .pipeline-card .pc-followers { font-size: 11px; color: #65676b; }
    .pipeline-card .pc-notes { font-size: 11px; color: #888; margin-top: 4px; font-style: italic; }
    .pipeline-card select {
      font-size: 11px; padding: 3px 6px; border: 1px solid #ddd; border-radius: 6px;
      margin-top: 6px; width: 100%;
    }
    .pipeline-card textarea {
      font-size: 11px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 6px;
      margin-top: 4px; width: 100%; resize: vertical; min-height: 40px; font-family: inherit;
    }
    .pipeline-card .save-btn {
      font-size: 11px; padding: 4px 10px; background: var(--accent); color: white;
      border: none; border-radius: 6px; cursor: pointer; margin-top: 4px;
    }
    .pipeline-card .save-btn:hover { opacity: 0.9; }

    .card-actions { padding: 0 20px 14px; }
    .add-campaign-btn {
      font-size: 12px; padding: 5px 12px; border: 1px solid var(--accent); color: var(--accent);
      background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;
    }
    .add-campaign-btn:hover { background: var(--accent); color: white; }

    /* AI Analytics */
    .analytics-container {
      max-width: 1200px; margin: 24px auto; padding: 0 32px;
    }
    .analytics-container h2 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
    .analytics-header {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;
    }
    .analytics-btn {
      padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
      cursor: pointer; border: none; transition: all 0.2s;
    }
    .analytics-btn-primary {
      background: var(--gradient); color: white;
    }
    .analytics-btn-primary:hover { opacity: 0.9; }
    .analytics-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .analytics-btn-danger {
      background: white; color: #dc2626; border: 1px solid #dc2626;
    }
    .analytics-btn-danger:hover { background: #fef2f2; }
    .analytics-progress {
      font-size: 13px; color: #65676b; font-style: italic;
    }
    .analytics-timestamp {
      font-size: 12px; color: #65676b; margin-left: auto;
    }
    .analytics-summary {
      display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;
    }
    .analytics-summary-card {
      flex: 1; min-width: 150px; padding: 16px; background: white; border-radius: 10px;
      text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .analytics-summary-card .as-value { font-size: 28px; font-weight: 700; color: var(--accent); }
    .analytics-summary-card .as-label { font-size: 12px; color: #65676b; text-transform: uppercase; margin-top: 4px; }

    .profiles-accordion {
      background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 24px; overflow: hidden;
    }
    .profiles-accordion-header {
      padding: 14px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #e4e6eb;
    }
    .profiles-accordion-header:hover { background: #f8f9fb; }
    .profiles-accordion-body {
      display: none; padding: 16px 20px;
    }
    .profiles-accordion-body.open { display: block; }
    .profile-item {
      padding: 12px 0; border-bottom: 1px solid #f0f0f0;
    }
    .profile-item:last-child { border-bottom: none; }
    .profile-item h4 { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
    .profile-item p { font-size: 13px; color: #444; line-height: 1.5; margin: 2px 0; }

    .analytics-filters {
      display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;
    }
    .analytics-filters select {
      padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px;
      background: white; cursor: pointer;
    }

    .analytics-table-wrap {
      background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow-x: auto;
    }
    .analytics-table {
      width: 100%; border-collapse: collapse; font-size: 13px;
    }
    .analytics-table th {
      padding: 12px 14px; text-align: left; font-size: 11px; font-weight: 600;
      color: #65676b; text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 2px solid #e4e6eb; cursor: pointer; user-select: none; white-space: nowrap;
    }
    .analytics-table th:hover { color: var(--accent); }
    .analytics-table td {
      padding: 10px 14px; border-bottom: 1px solid #f0f0f0; vertical-align: middle;
    }
    .analytics-table tr:hover { background: #f8f9fb; }
    .platform-badge {
      display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px;
      font-weight: 600; text-transform: uppercase;
    }
    .platform-badge-instagram { background: #fce7f3; color: #be185d; }
    .platform-badge-youtube { background: #fee2e2; color: #dc2626; }
    .score-bar {
      display: inline-block; height: 8px; border-radius: 4px; min-width: 8px;
    }
    .score-bar-red { background: #ef4444; }
    .score-bar-yellow { background: #f59e0b; }
    .score-bar-green { background: #10b981; }
    .score-num {
      display: inline-block; width: 24px; font-weight: 700; text-align: right; margin-right: 6px;
    }
    .score-num-red { color: #ef4444; }
    .score-num-yellow { color: #f59e0b; }
    .score-num-green { color: #10b981; }
    .expand-btn {
      background: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;
      font-size: 11px; padding: 2px 6px; color: #65676b;
    }
    .expand-btn:hover { border-color: var(--accent); color: var(--accent); }
    .expanded-scores {
      display: none; padding: 8px 14px 12px; background: #f8f9fb;
    }
    .expanded-scores.open { display: table-row; }
    .mini-score-row {
      display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 12px;
    }
    .mini-score-label { width: 220px; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-score-bar-bg { flex: 1; height: 6px; background: #e4e6eb; border-radius: 3px; overflow: hidden; max-width: 200px; }
    .mini-score-bar-fill { height: 100%; border-radius: 3px; }
    .mini-score-val { width: 24px; text-align: right; font-weight: 600; }
    .reasoning-text { font-size: 12px; color: #65676b; max-width: 250px; line-height: 1.4; }
    .analytics-empty {
      text-align: center; padding: 60px 20px; color: #65676b;
    }
    .analytics-empty p { margin-bottom: 16px; font-size: 16px; }

    @media (max-width: 900px) {
      .calc-grid { grid-template-columns: 1fr; }
      .pipeline-columns { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .header, .stats-bar, .controls, .grid, .tabs, .filter-chips { padding-left: 16px; padding-right: 16px; }
      .grid { grid-template-columns: 1fr; }
      .methodology, .revenue-container, .campaign-container { padding: 0 16px; }
      .pipeline-columns { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>#higgsfield Creator Dashboard</h1>
    <p>Instagram &amp; YouTube creators for influencer partnerships</p>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="creators">Creators</div>
    <div class="tab" data-tab="revenue">Revenue Projections</div>
    <div class="tab" data-tab="campaigns">Campaign Tracker</div>
    <div class="tab" data-tab="analytics">AI Analytics</div>
    <div class="tab" data-tab="scoring">How Scoring Works</div>
    <div class="tab" data-tab="methodology">How Engagement Works</div>
  </div>

  <!-- Creators Tab -->
  <div id="tab-creators" class="tab-content active">
    <div class="stats-bar" id="stats-bar"></div>
    <div class="filter-chips" id="tier-filters"></div>
    <div class="filter-chips" id="niche-filters"></div>
    <div class="controls">
      <input type="text" id="search" placeholder="Search by username, name, or bio...">
      <select id="platform-filter">
        <option value="all">All Platforms</option>
        <option value="instagram">Instagram</option>
        <option value="youtube">YouTube</option>
      </select>
      <select id="sort"></select>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none">No creators match your search.</div>
  </div>

  <!-- Revenue Projections Tab -->
  <div id="tab-revenue" class="tab-content">
    <div class="revenue-container">
      <h2>Revenue Projection Calculator</h2>
      <p style="color:#65676b; margin-bottom:20px; font-size:14px;">Model expected revenue from creator partnerships against the $10K subscription goal.</p>

      <div class="scenario-buttons">
        <button class="scenario-btn" data-scenario="conservative">Conservative</button>
        <button class="scenario-btn active" data-scenario="moderate">Moderate</button>
        <button class="scenario-btn" data-scenario="optimistic">Optimistic</button>
      </div>

      <div class="calc-grid">
        <div class="calc-panel">
          <h3>Inputs</h3>
          <div class="input-group">
            <label>Subscription Price ($) <span class="range-value" id="price-val">$9.99</span></label>
            <input type="number" id="calc-price" value="9.99" min="0.99" step="0.01">
          </div>
          <div class="input-group">
            <label>Number of Creator Partners <span class="range-value" id="partners-val">5</span></label>
            <input type="range" id="calc-partners" min="1" max="20" value="5">
          </div>
          <div class="input-group">
            <label id="reach-label">Avg Audience Reach per Creator <span class="range-value" id="reach-val">0</span></label>
            <input type="number" id="calc-reach" value="0" min="0">
          </div>
          <div class="input-group">
            <label>Content View Rate (%) <span class="range-value" id="viewrate-val">10%</span></label>
            <input type="range" id="calc-viewrate" min="1" max="50" value="10">
          </div>
          <div class="input-group">
            <label>Conversion Rate (%) <span class="range-value" id="convrate-val">5%</span></label>
            <input type="range" id="calc-convrate" min="1" max="20" value="5">
          </div>
        </div>

        <div class="calc-panel">
          <h3>Projected Results</h3>
          <div id="calc-output"></div>
          <div class="progress-container">
            <div style="font-size:13px; font-weight:600; margin-bottom:6px;">Progress to $10K Goal</div>
            <div class="progress-bar-bg">
              <div class="progress-bar-fill" id="goal-progress" style="width:0%"></div>
            </div>
            <div class="progress-label">
              <span id="goal-current">$0</span>
              <span>$10,000</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Campaign Tracker Tab -->
  <div id="tab-campaigns" class="tab-content">
    <div class="campaign-container">
      <h2>Campaign Outreach Tracker</h2>
      <div class="pipeline-stats" id="pipeline-stats"></div>
      <div class="pipeline-columns" id="pipeline-columns">
        <div class="pipeline-col" id="col-not_contacted">
          <div class="pipeline-col-header">Not Contacted <span class="col-count" id="count-not_contacted">0</span></div>
          <div class="pipeline-list" id="list-not_contacted"></div>
        </div>
        <div class="pipeline-col" id="col-contacted">
          <div class="pipeline-col-header">Contacted <span class="col-count" id="count-contacted">0</span></div>
          <div class="pipeline-list" id="list-contacted"></div>
        </div>
        <div class="pipeline-col" id="col-confirmed">
          <div class="pipeline-col-header">Confirmed <span class="col-count" id="count-confirmed">0</span></div>
          <div class="pipeline-list" id="list-confirmed"></div>
        </div>
        <div class="pipeline-col" id="col-content_posted">
          <div class="pipeline-col-header">Content Posted <span class="col-count" id="count-content_posted">0</span></div>
          <div class="pipeline-list" id="list-content_posted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Analytics Tab -->
  <div id="tab-analytics" class="tab-content">
    <div class="analytics-container">
      <h2>AI Profile-Fit Analytics</h2>
      <div class="analytics-header">
        <button class="analytics-btn analytics-btn-primary" id="run-analysis-btn" onclick="triggerAnalysis()">Run Analysis</button>
        <button class="analytics-btn analytics-btn-danger" id="clear-analysis-btn" onclick="clearAndRerun()">Clear &amp; Re-run</button>
        <span class="analytics-progress" id="analysis-progress"></span>
        <span class="analytics-timestamp" id="analysis-timestamp"></span>
      </div>
      <div class="analytics-summary" id="analytics-summary"></div>
      <div class="profiles-accordion">
        <div class="profiles-accordion-header" onclick="toggleProfilesAccordion()">
          Ideal Creator Profiles <span id="accordion-arrow">&#9654;</span>
        </div>
        <div class="profiles-accordion-body" id="profiles-accordion-body"></div>
      </div>
      <div class="analytics-filters" id="analytics-filters" style="display:none">
        <select id="filter-profile" onchange="renderAnalyticsTable()">
          <option value="all">All Profiles</option>
        </select>
        <select id="filter-platform-analytics" onchange="renderAnalyticsTable()">
          <option value="all">All Platforms</option>
          <option value="instagram">Instagram</option>
          <option value="youtube">YouTube</option>
        </select>
      </div>
      <div id="analytics-table-container"></div>
    </div>
  </div>

  <!-- How Scoring Works Tab -->
  <div id="tab-scoring" class="tab-content">
    <div class="methodology">
      <h2>How AI Profile-Fit Scoring Works</h2>
      <p>The AI Analytics tab scores every scraped creator against our 5 ideal creator profiles to help the team prioritize outreach. Here's how it works in plain terms.</p>

      <h3>The 5 Ideal Profiles</h3>
      <p>We've defined 5 types of creators most likely to drive Higgsfield subscriptions: Workflow Tutorial Videomakers, UGC/Ad Creative Agencies, Creative Entrepreneurs, AI Tool Comparison Reviewers, and Cinematic Breakdown Creators. Each profile describes an audience type, content style, and why they're a good fit.</p>

      <h3>What Gets Sent to AI</h3>
      <p>For each creator, we send their <strong>bio/description</strong>, <strong>follower or subscriber count</strong>, <strong>engagement rate</strong>, <strong>detected niches</strong>, and <strong>platform</strong> (Instagram or YouTube). Creators are sent in batches of 10 for efficiency.</p>

      <h3>How Scores Are Calculated</h3>
      <p>An AI model (GPT-4o-mini) reads each creator's data alongside all 5 ideal profiles and assigns a <strong>fit score from 0 to 10</strong> for each profile. That means every creator gets 5 scores. The highest one becomes their "Best Fit" score, and the matching profile becomes their "Best Fit Profile."</p>

      <div class="formula-box">
        <div class="formula">Each creator &rarr; 5 scores (0-10) &rarr; Best fit = highest score</div>
        <div class="formula-note">Scored by GPT-4o-mini based on bio, audience size, engagement, and niche match</div>
      </div>

      <h3>What the Scores Mean</h3>
      <table class="scale-table">
        <thead><tr><th>Score</th><th>Meaning</th></tr></thead>
        <tbody>
          <tr><td class="rate">0 &ndash; 3</td><td>Poor fit &mdash; creator's content and audience don't align with this profile</td></tr>
          <tr><td class="rate">4 &ndash; 6</td><td>Moderate fit &mdash; some overlap, but not a strong match</td></tr>
          <tr><td class="rate">7 &ndash; 10</td><td>Strong fit &mdash; creator closely matches the ideal profile's audience and content style</td></tr>
        </tbody>
      </table>

      <h3>What to Do with the Results</h3>
      <p>Sort the results table by score (highest first) to find your best outreach candidates. Use the profile filter to find creators who match a specific ideal profile. The "Reasoning" column explains why the AI gave that score, so you can quickly validate before reaching out.</p>

      <div class="note-box">
        Scores are based on publicly available data (bios, follower counts, engagement). The AI doesn't see private analytics, sponsorship history, or content quality beyond what's in the description. Use scores as a starting point, not a final decision.
      </div>
    </div>
  </div>

  <!-- How Engagement Works Tab -->
  <div id="tab-methodology" class="tab-content">
    <div class="methodology" id="methodology-content"></div>
  </div>

  <script>
    // ========== STATE ==========
    let allCreators = [];       // unified: IG + YT with .platform field
    let campaignStatuses = {};  // { id: status } for both platforms
    let activeTierFilter = 'all';
    let activeNicheFilter = 'all';
    let activePlatformFilter = 'all';

    function formatNum(n) {
      if (n == null) return '0';
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toLocaleString();
    }

    function formatMoney(n) {
      return '$' + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Normalize both platforms into a unified shape
    function normalizeIgCreator(c) {
      return { ...c, platform: 'instagram', _id: c.username,
        _name: c.full_name || c.username, _displayName: c.username,
        _avatarSrc: `/avatars/${c.username}.jpg`,
        _profileUrl: `https://www.instagram.com/${c.username}/`,
        _bio: c.biography || '', _audience: c.followers || 0,
        _contentCount: c.posts_count || 0, _contentLabel: 'Posts' };
    }
    function normalizeYtCreator(c) {
      return { ...c, platform: 'youtube', _id: c.channel_id,
        _name: c.channel_name || c.handle || 'Unknown',
        _displayName: c.channel_name || c.handle || 'Unknown',
        _avatarSrc: `/yt-avatars/${c.channel_id}.jpg`,
        _profileUrl: c.channel_url || '#',
        _bio: c.description || '', _audience: c.subscribers || 0,
        _contentCount: c.video_count || 0, _contentLabel: 'Videos' };
    }

    function getVisibleCreators() {
      let data = allCreators;
      if (activePlatformFilter !== 'all') data = data.filter(c => c.platform === activePlatformFilter);
      return data;
    }

    // ========== SORT OPTIONS ==========
    function renderSortOptions() {
      document.getElementById('sort').innerHTML = `
        <option value="audience-desc">Audience (High to Low)</option>
        <option value="audience-asc">Audience (Low to High)</option>
        <option value="engagement-desc">Engagement (High to Low)</option>
        <option value="engagement-asc">Engagement (Low to High)</option>
        <option value="content-desc">Content Count (High to Low)</option>
        <option value="name-asc">Name (A-Z)</option>
        <option value="name-desc">Name (Z-A)</option>
      `;
    }

    // ========== STATS BAR ==========
    function renderStats() {
      const data = getVisibleCreators();
      const engagementRates = data.filter(c => c.engagement_rate > 0).map(c => c.engagement_rate);
      const avgEngagement = engagementRates.length
        ? (engagementRates.reduce((a, b) => a + b, 0) / engagementRates.length).toFixed(2) : '0';
      const totalAudience = data.reduce((s, c) => s + c._audience, 0);
      const avgAudience = data.length ? Math.round(totalAudience / data.length) : 0;
      const tierCounts = { 'mid-tier': 0, micro: 0, nano: 0 };
      data.forEach(c => { if (c.tier && tierCounts[c.tier] !== undefined) tierCounts[c.tier]++; });
      const igCount = data.filter(c => c.platform === 'instagram').length;
      const ytCount = data.filter(c => c.platform === 'youtube').length;

      document.getElementById('stats-bar').innerHTML = `
        <div class="stat-card"><div class="value">${data.length}</div><div class="label">Creators</div></div>
        <div class="stat-card"><div class="value">${formatNum(totalAudience)}</div><div class="label">Total Reach</div></div>
        <div class="stat-card"><div class="value">${formatNum(avgAudience)}</div><div class="label">Avg Audience</div></div>
        <div class="stat-card"><div class="value">${avgEngagement}%</div><div class="label">Avg Engagement</div></div>
        <div class="stat-card"><div class="value">${igCount}</div><div class="label">Instagram</div></div>
        <div class="stat-card"><div class="value">${ytCount}</div><div class="label">YouTube</div></div>
        <div class="stat-card"><div class="value">${tierCounts['mid-tier']}</div><div class="label">Mid-tier</div></div>
        <div class="stat-card"><div class="value">${tierCounts.micro}</div><div class="label">Micro</div></div>
      `;
    }

    // ========== FILTER CHIPS ==========
    function renderFilterChips() {
      const data = getVisibleCreators();
      const tierCounts = { 'mid-tier': 0, micro: 0, nano: 0 };
      data.forEach(c => { if (c.tier && tierCounts[c.tier] !== undefined) tierCounts[c.tier]++; });

      const tierLabels = { all: 'All', 'mid-tier': 'Mid-tier (100K-500K)', micro: 'Micro (10K-100K)', nano: 'Nano (<10K)' };
      let tierHtml = '';
      for (const [key, label] of Object.entries(tierLabels)) {
        const count = key === 'all' ? data.length : tierCounts[key] || 0;
        tierHtml += `<div class="chip ${activeTierFilter === key ? 'active' : ''}" data-tier="${key}">${label}<span class="count">(${count})</span></div>`;
      }
      document.getElementById('tier-filters').innerHTML = tierHtml;

      const nicheCounts = {};
      data.forEach(c => { (c.niches || []).forEach(n => { nicheCounts[n] = (nicheCounts[n] || 0) + 1; }); });
      const sortedNiches = Object.entries(nicheCounts).sort((a, b) => b[1] - a[1]);
      let nicheHtml = `<div class="chip ${activeNicheFilter === 'all' ? 'active' : ''}" data-niche="all">All Niches</div>`;
      for (const [niche, count] of sortedNiches) {
        nicheHtml += `<div class="chip ${activeNicheFilter === niche ? 'active' : ''}" data-niche="${niche}">${niche}<span class="count">(${count})</span></div>`;
      }
      document.getElementById('niche-filters').innerHTML = nicheHtml;

      document.querySelectorAll('[data-tier]').forEach(chip => {
        chip.addEventListener('click', () => { activeTierFilter = chip.dataset.tier; renderFilterChips(); render(); });
      });
      document.querySelectorAll('[data-niche]').forEach(chip => {
        chip.addEventListener('click', () => { activeNicheFilter = chip.dataset.niche; renderFilterChips(); render(); });
      });
    }

    // ========== CREATOR CARDS ==========
    function renderCard(c) {
      const isYt = c.platform === 'youtube';
      const initial = c._displayName[0]?.toUpperCase() || '?';
      const avatarHtml = `<img class="avatar" src="${c._avatarSrc}" alt="${c._displayName}" onerror="this.outerHTML='<div class=\\'avatar-fallback\\'>${initial}</div>'">`;
      const verifiedHtml = c.is_verified ? '<span class="verified-badge">&#10003;</span>' : '';
      const tierClass = c.tier ? `tier-${c.tier}` : '';
      const tierLabel = c.tier ? c.tier.replace('-', ' ') : '';
      const tierHtml = c.tier ? `<span class="tier-badge ${tierClass}">${tierLabel}</span>` : '';
      const platformBadge = `<span class="platform-badge platform-badge-${c.platform}" style="margin-left:6px">${isYt ? 'YT' : 'IG'}</span>`;

      const campaignStatus = campaignStatuses[c._id];
      const dotHtml = campaignStatus ? `<span class="campaign-dot dot-${campaignStatus}" title="${campaignStatus.replace(/_/g, ' ')}"></span>` : '';
      const nichesHtml = (c.niches && c.niches.length > 0)
        ? `<div class="niche-tags">${c.niches.map(n => `<span class="niche-tag">${n}</span>`).join('')}</div>` : '';
      const actionHtml = !campaignStatus
        ? `<div class="card-actions"><button class="add-campaign-btn" data-id="${c._id}" data-platform="${c.platform}">+ Add to Campaign</button></div>` : '';

      const namePrefix = isYt ? '' : '@';
      const handleLine = isYt && c.handle ? `<div class="fullname">@${c.handle}</div>` : '';
      const fullnameLine = !isYt ? `<div class="fullname">${c.full_name || ''}</div>` : '';
      const categoryHtml = !isYt && c.business_category ? `<div class="category">${c.business_category}</div>` : '';

      const statsHtml = `
        <div class="card-stat"><div class="num">${formatNum(c._audience)}</div><div class="lbl">${isYt ? 'Subscribers' : 'Followers'}</div></div>
        <div class="card-stat"><div class="num">${formatNum(c._contentCount)}</div><div class="lbl">${c._contentLabel}</div></div>
        <div class="card-stat"><div class="num">${c.engagement_rate ?? 0}%</div><div class="lbl">Engagement</div></div>
      `;

      return `
        <div class="card">
          <div class="card-header">
            ${avatarHtml}
            <div class="card-identity">
              <a class="username" href="${c._profileUrl}" target="_blank" rel="noopener">
                ${namePrefix}${c._displayName} ${verifiedHtml}
              </a>
              ${platformBadge}${tierHtml}${dotHtml}
              ${handleLine}${fullnameLine}${categoryHtml}
            </div>
          </div>
          ${c._bio ? `<div class="card-bio">${c._bio.replace(/\n/g, '<br>')}</div>` : ''}
          ${nichesHtml}
          ${actionHtml}
          <div class="card-stats">${statsHtml}</div>
        </div>
      `;
    }

    function getFiltered() {
      const q = document.getElementById('search').value.toLowerCase();
      const sort = document.getElementById('sort').value;
      let data = getVisibleCreators();

      let filtered = data.filter(c => {
        const searchText = `${c._displayName} ${c._name} ${c._bio} ${c.handle || ''}`.toLowerCase();
        const matchesSearch = searchText.includes(q);
        const matchesTier = activeTierFilter === 'all' || c.tier === activeTierFilter;
        const matchesNiche = activeNicheFilter === 'all' || (c.niches && c.niches.includes(activeNicheFilter));
        return matchesSearch && matchesTier && matchesNiche;
      });

      const [field, dir] = sort.split('-');
      filtered.sort((a, b) => {
        let va, vb;
        if (field === 'audience') { va = a._audience; vb = b._audience; }
        else if (field === 'content') { va = a._contentCount; vb = b._contentCount; }
        else if (field === 'engagement') { va = a.engagement_rate || 0; vb = b.engagement_rate || 0; }
        else { va = a._name.toLowerCase(); vb = b._name.toLowerCase();
          return dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va); }
        return dir === 'asc' ? va - vb : vb - va;
      });
      return filtered;
    }

    function render() {
      const filtered = getFiltered();
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');

      if (filtered.length === 0) { grid.innerHTML = ''; empty.style.display = 'block'; }
      else { empty.style.display = 'none'; grid.innerHTML = filtered.map(renderCard).join(''); }

      document.querySelectorAll('.add-campaign-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const platform = btn.dataset.platform;
          const endpoint = platform === 'youtube' ? `/api/yt/campaigns/${id}` : `/api/campaigns/${id}`;
          await fetch(endpoint, { method: 'PUT', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'not_contacted', notes: '' }) });
          campaignStatuses[id] = 'not_contacted';
          render();
          loadCampaigns();
        });
      });
    }

    // ========== REVENUE CALCULATOR ==========
    const scenarios = {
      conservative: { viewrate: 5, convrate: 2, partners: 3 },
      moderate: { viewrate: 10, convrate: 5, partners: 5 },
      optimistic: { viewrate: 20, convrate: 8, partners: 10 }
    };

    function updateCalc() {
      const price = parseFloat(document.getElementById('calc-price').value) || 0;
      const partners = parseInt(document.getElementById('calc-partners').value) || 0;
      const reach = parseInt(document.getElementById('calc-reach').value) || 0;
      const viewrate = parseInt(document.getElementById('calc-viewrate').value) || 0;
      const convrate = parseInt(document.getElementById('calc-convrate').value) || 0;

      document.getElementById('price-val').textContent = formatMoney(price);
      document.getElementById('partners-val').textContent = partners;
      document.getElementById('reach-val').textContent = formatNum(reach);
      document.getElementById('viewrate-val').textContent = viewrate + '%';
      document.getElementById('convrate-val').textContent = convrate + '%';

      const totalReach = partners * reach;
      const pageVisits = Math.round(totalReach * (viewrate / 100));
      const conversions = Math.round(pageVisits * (convrate / 100));
      const revenue = conversions * price;
      const budget = 2000;
      const efficiency = budget > 0 ? (revenue / budget).toFixed(2) : 0;
      const goalPct = Math.min(100, (revenue / 10000) * 100);

      document.getElementById('calc-output').innerHTML = `
        <div class="output-row"><span class="out-label">Total Audience Reach</span><span class="out-value">${formatNum(totalReach)}</span></div>
        <div class="output-row"><span class="out-label">Estimated Page Visits</span><span class="out-value">${formatNum(pageVisits)}</span></div>
        <div class="output-row"><span class="out-label">Estimated Conversions</span><span class="out-value">${formatNum(conversions)}</span></div>
        <div class="output-row"><span class="out-label">Projected Revenue</span><span class="out-value revenue">${formatMoney(revenue)}</span></div>
        <div class="output-row"><span class="out-label">Budget Efficiency</span><span class="out-value">${efficiency}x per $1 spent</span></div>
      `;
      document.getElementById('goal-progress').style.width = goalPct + '%';
      document.getElementById('goal-current').textContent = formatMoney(revenue);
    }

    function updateReach() {
      const data = getVisibleCreators();
      if (data.length > 0) {
        const avgReach = Math.round(data.reduce((sum, c) => sum + c._audience, 0) / data.length);
        document.getElementById('calc-reach').value = avgReach;
      }
      updateCalc();
    }

    function setScenario(name) {
      const s = scenarios[name];
      document.getElementById('calc-viewrate').value = s.viewrate;
      document.getElementById('calc-convrate').value = s.convrate;
      document.getElementById('calc-partners').value = s.partners;
      document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-scenario="${name}"]`).classList.add('active');
      updateCalc();
    }

    document.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', () => setScenario(btn.dataset.scenario));
    });
    ['calc-price', 'calc-partners', 'calc-reach', 'calc-viewrate', 'calc-convrate'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
        updateCalc();
      });
    });

    // ========== CAMPAIGN TRACKER ==========
    async function loadCampaigns() {
      const [igCampaigns, igStats, ytCampaigns, ytStats] = await Promise.all([
        fetch('/api/campaigns').then(r => r.json()),
        fetch('/api/campaigns/stats').then(r => r.json()),
        fetch('/api/yt/campaigns').then(r => r.json()),
        fetch('/api/yt/campaigns/stats').then(r => r.json()),
      ]);

      // Merge campaign statuses
      campaignStatuses = {};
      igCampaigns.forEach(c => { campaignStatuses[c.username] = c.status; });
      ytCampaigns.forEach(c => { campaignStatuses[c.channel_id] = c.status; });

      // Merge campaigns with platform tag
      const allCampaigns = [
        ...igCampaigns.map(c => ({ ...c, platform: 'instagram', _id: c.username,
          _name: c.username, _audience: c.followers, _avatarSrc: `/avatars/${c.username}.jpg` })),
        ...ytCampaigns.map(c => ({ ...c, platform: 'youtube', _id: c.channel_id,
          _name: c.channel_name || c.channel_id, _audience: c.subscribers,
          _avatarSrc: `/yt-avatars/${c.channel_id}.jpg` })),
      ];

      const mergedStats = {
        not_contacted: (igStats.not_contacted || 0) + (ytStats.not_contacted || 0),
        contacted: (igStats.contacted || 0) + (ytStats.contacted || 0),
        confirmed: (igStats.confirmed || 0) + (ytStats.confirmed || 0),
        content_posted: (igStats.content_posted || 0) + (ytStats.content_posted || 0),
        total: (igStats.total || 0) + (ytStats.total || 0),
      };
      const total = mergedStats.total || 1;

      document.getElementById('pipeline-stats').innerHTML = `
        <div class="pipeline-stat ps-not_contacted"><div class="ps-value">${mergedStats.not_contacted}</div><div class="ps-label">Not Contacted</div><div class="ps-pct">${Math.round(mergedStats.not_contacted / total * 100)}%</div></div>
        <div class="pipeline-stat ps-contacted"><div class="ps-value">${mergedStats.contacted}</div><div class="ps-label">Contacted</div><div class="ps-pct">${Math.round(mergedStats.contacted / total * 100)}%</div></div>
        <div class="pipeline-stat ps-confirmed"><div class="ps-value">${mergedStats.confirmed}</div><div class="ps-label">Confirmed</div><div class="ps-pct">${Math.round(mergedStats.confirmed / total * 100)}%</div></div>
        <div class="pipeline-stat ps-content_posted"><div class="ps-value">${mergedStats.content_posted}</div><div class="ps-label">Content Posted</div><div class="ps-pct">${Math.round(mergedStats.content_posted / total * 100)}%</div></div>
      `;

      const statuses = ['not_contacted', 'contacted', 'confirmed', 'content_posted'];
      const statusLabels = { not_contacted: 'Not Contacted', contacted: 'Contacted', confirmed: 'Confirmed', content_posted: 'Content Posted' };

      statuses.forEach(status => {
        const items = allCampaigns.filter(c => c.status === status);
        document.getElementById(`count-${status}`).textContent = items.length;
        document.getElementById(`list-${status}`).innerHTML = items.map(c => {
          const initial = c._name[0]?.toUpperCase() || '?';
          const avatarHtml = `<img class="avatar-small" src="${c._avatarSrc}" onerror="this.outerHTML='<div class=\\'avatar-fallback-small\\'>${initial}</div>'">`;
          const platformTag = `<span class="platform-badge platform-badge-${c.platform}" style="margin-left:4px">${c.platform === 'youtube' ? 'YT' : 'IG'}</span>`;
          return `
            <div class="pipeline-card" data-id="${c._id}" data-platform="${c.platform}">
              <div class="pipeline-card-row">
                ${avatarHtml}
                <div class="pc-info">
                  <div class="pc-username">${c.platform === 'instagram' ? '@' : ''}${c._name} ${platformTag}</div>
                  <div class="pc-followers">${formatNum(c._audience)} ${c.platform === 'youtube' ? 'subscribers' : 'followers'}</div>
                </div>
              </div>
              ${c.notes ? `<div class="pc-notes">${c.notes}</div>` : ''}
              <select class="status-select" data-id="${c._id}">
                ${statuses.map(s => `<option value="${s}" ${s === status ? 'selected' : ''}>${statusLabels[s]}</option>`).join('')}
              </select>
              <textarea class="notes-input" data-id="${c._id}" placeholder="Add notes...">${c.notes || ''}</textarea>
              <button class="save-btn" data-id="${c._id}" data-platform="${c.platform}">Save</button>
            </div>
          `;
        }).join('');
      });

      document.querySelectorAll('.pipeline-card .save-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const platform = btn.dataset.platform;
          const card = btn.closest('.pipeline-card');
          const newStatus = card.querySelector('.status-select').value;
          const notes = card.querySelector('.notes-input').value;
          const endpoint = platform === 'youtube' ? `/api/yt/campaigns/${id}` : `/api/campaigns/${id}`;
          await fetch(endpoint, { method: 'PUT', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus, notes }) });
          loadCampaigns();
          render();
        });
      });
    }

    // ========== METHODOLOGY ==========
    function renderMethodology() {
      document.getElementById('methodology-content').innerHTML = `
        <h2>Understanding Engagement Rate</h2>
        <p>Engagement rate measures how actively a creator's audience interacts with their content. It's calculated differently per platform but serves the same purpose: identifying creators whose audiences actually pay attention.</p>

        <h3>Instagram Formula</h3>
        <div class="formula-box">
          <div class="formula">(Likes + Comments) / Followers &times; 100</div>
          <div class="formula-note">Sum of likes and comments across recent posts, divided by follower count</div>
        </div>

        <h3>YouTube Formula</h3>
        <div class="formula-box">
          <div class="formula">(Avg Likes + Avg Comments) / Avg Views &times; 100</div>
          <div class="formula-note">Averaged across the channel's recent videos</div>
        </div>

        <h3>What the Numbers Mean</h3>
        <table class="scale-table">
          <thead><tr><th>Rate</th><th>Instagram</th><th>YouTube</th></tr></thead>
          <tbody>
            <tr><td class="rate">&lt; 1%</td><td>Low &mdash; passive audience</td><td>Low &mdash; viewers rarely interact</td></tr>
            <tr><td class="rate">1-3%</td><td>Average for larger accounts</td><td>Average for most channels</td></tr>
            <tr><td class="rate">3-6%</td><td>Good &mdash; responsive audience</td><td>Good &mdash; strong community</td></tr>
            <tr><td class="rate">6%+</td><td>Excellent &mdash; niche creators</td><td>Excellent &mdash; highly engaged</td></tr>
          </tbody>
        </table>

        <h3>Why It Matters</h3>
        <p>A creator with 20K followers and 8% engagement is often more valuable for partnerships than one with 200K followers and 0.5% engagement. High engagement signals audience trust and likelihood to act on recommendations.</p>

        <div class="note-box">
          Both platforms track additional engagement metrics (shares, saves, watch time) that are only visible to the account owner. Our calculations use publicly accessible data: likes and comments for Instagram; likes, comments, and views for YouTube.
        </div>
      `;
    }

    // ========== AI ANALYTICS ==========
    let analysisResults = [];
    let idealProfiles = [];
    let analyticsSortField = 'best_fit_score';
    let analyticsSortDir = 'desc';

    async function loadIdealProfiles() {
      try {
        idealProfiles = await fetch('/api/analysis/profiles').then(r => r.json());
        renderProfilesAccordion();
      } catch (e) { console.error('Failed to load profiles:', e); }
    }

    function renderProfilesAccordion() {
      document.getElementById('profiles-accordion-body').innerHTML = idealProfiles.map(p => `
        <div class="profile-item">
          <h4>${p.Profile}</h4>
          <p>${p['Short Description (Audience  Niche  Platform)']}</p>
          <p><strong>Examples:</strong> ${p['Example Creators']}</p>
          <p><strong>Scale:</strong> ${p['Audience Scale']}</p>
        </div>
      `).join('');
    }

    function toggleProfilesAccordion() {
      const body = document.getElementById('profiles-accordion-body');
      const arrow = document.getElementById('accordion-arrow');
      body.classList.toggle('open');
      arrow.innerHTML = body.classList.contains('open') ? '&#9660;' : '&#9654;';
    }

    async function loadAnalysisResults() {
      try {
        const [results, stats] = await Promise.all([
          fetch('/api/analysis/results').then(r => r.json()),
          fetch('/api/analysis/stats').then(r => r.json()),
        ]);
        analysisResults = results;
        renderAnalyticsSummary(stats);
        populateProfileFilter();
        renderAnalyticsTable();
        if (results.length > 0) {
          document.getElementById('analysis-timestamp').textContent =
            'Last analyzed: ' + new Date(results[0].analyzed_at).toLocaleString();
        }
      } catch (e) { console.error('Failed to load analysis:', e); }
    }

    function renderAnalyticsSummary(stats) {
      const el = document.getElementById('analytics-summary');
      if (!stats || stats.total === 0) { el.innerHTML = ''; return; }
      let profileCards = '';
      if (stats.by_profile) {
        profileCards = stats.by_profile.slice(0, 3).map(p => `
          <div class="analytics-summary-card"><div class="as-value">${p.count}</div><div class="as-label">${p.best_fit_profile}</div></div>
        `).join('');
      }
      el.innerHTML = `
        <div class="analytics-summary-card"><div class="as-value">${stats.total}</div><div class="as-label">Total Analyzed</div></div>
        <div class="analytics-summary-card"><div class="as-value">${stats.avg_score ?? 0}</div><div class="as-label">Avg Fit Score</div></div>
        ${profileCards}
      `;
    }

    function populateProfileFilter() {
      const select = document.getElementById('filter-profile');
      const profiles = [...new Set(analysisResults.map(r => r.best_fit_profile))];
      select.innerHTML = '<option value="all">All Profiles</option>' +
        profiles.map(p => `<option value="${p}">${p}</option>`).join('');
    }

    function scoreColor(score) {
      if (score <= 3) return 'red';
      if (score <= 6) return 'yellow';
      return 'green';
    }

    function getCreatorEngagement(creatorId, platform) {
      const c = allCreators.find(cr => cr._id === creatorId && cr.platform === platform);
      return c ? (c.engagement_rate ?? 0) : 0;
    }

    function renderAnalyticsTable() {
      const container = document.getElementById('analytics-table-container');
      const profileFilter = document.getElementById('filter-profile').value;
      const platformFilter = document.getElementById('filter-platform-analytics').value;

      let data = [...analysisResults];
      if (profileFilter !== 'all') data = data.filter(r => r.best_fit_profile === profileFilter);
      if (platformFilter !== 'all') data = data.filter(r => r.platform === platformFilter);

      data.sort((a, b) => {
        let va, vb;
        if (analyticsSortField === 'best_fit_score') { va = a.best_fit_score; vb = b.best_fit_score; }
        else if (analyticsSortField === 'creator_name') {
          va = (a.creator_name || '').toLowerCase(); vb = (b.creator_name || '').toLowerCase();
          return analyticsSortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
        } else if (analyticsSortField === 'platform') {
          va = a.platform; vb = b.platform;
          return analyticsSortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
        } else if (analyticsSortField === 'engagement') {
          va = getCreatorEngagement(a.creator_id, a.platform);
          vb = getCreatorEngagement(b.creator_id, b.platform);
        } else { va = a.best_fit_score; vb = b.best_fit_score; }
        return analyticsSortDir === 'asc' ? va - vb : vb - va;
      });

      if (data.length === 0) {
        container.innerHTML = `<div class="analytics-empty"><p>No analysis results yet.</p><p>Click "Run Analysis" to score creators against ideal profiles.</p></div>`;
        document.getElementById('analytics-filters').style.display = 'none';
        return;
      }

      document.getElementById('analytics-filters').style.display = 'flex';
      const sortArrow = (field) => analyticsSortField !== field ? '' : (analyticsSortDir === 'asc' ? ' &#9650;' : ' &#9660;');
      const profileNames = idealProfiles.map(p => p.Profile);

      let rows = data.map((r, idx) => {
        const color = scoreColor(r.best_fit_score);
        const barWidth = r.best_fit_score * 10;
        let scores = {};
        try { scores = typeof r.profile_scores === 'string' ? JSON.parse(r.profile_scores) : r.profile_scores; } catch(e) {}

        const miniScores = profileNames.map(name => {
          const s = scores[name] ?? 0; const c = scoreColor(s);
          return `<div class="mini-score-row"><span class="mini-score-label">${name}</span>
            <div class="mini-score-bar-bg"><div class="mini-score-bar-fill score-bar-${c}" style="width:${s*10}%"></div></div>
            <span class="mini-score-val score-num-${c}">${s}</span></div>`;
        }).join('');

        const inCampaign = !!campaignStatuses[r.creator_id];
        const addBtn = !inCampaign
          ? `<button class="add-campaign-btn analytics-add-btn" data-id="${r.creator_id}" data-platform="${r.platform}">+ Campaign</button>`
          : '<span style="font-size:11px;color:#10b981;">In campaign</span>';

        const engagement = getCreatorEngagement(r.creator_id, r.platform);

        return `
          <tr>
            <td>${idx + 1}</td>
            <td><strong>${r.creator_name || r.creator_id}</strong></td>
            <td><span class="platform-badge platform-badge-${r.platform}">${r.platform === 'youtube' ? 'YT' : 'IG'}</span></td>
            <td>${r.best_fit_profile}</td>
            <td>
              <span class="score-num score-num-${color}">${r.best_fit_score}</span>
              <span class="score-bar score-bar-${color}" style="width:${barWidth}px"></span>
            </td>
            <td>${engagement}%</td>
            <td><button class="expand-btn" onclick="toggleScoreRow(this, ${idx})">Scores</button></td>
            <td class="reasoning-text">${r.reasoning || ''}</td>
            <td>${addBtn}</td>
          </tr>
          <tr class="expanded-scores" id="score-row-${idx}">
            <td colspan="9" style="padding:12px 20px; background:#f8f9fb;">${miniScores}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `<div class="analytics-table-wrap"><table class="analytics-table">
        <thead><tr>
          <th>#</th>
          <th onclick="sortAnalytics('creator_name')">Creator${sortArrow('creator_name')}</th>
          <th onclick="sortAnalytics('platform')">Platform${sortArrow('platform')}</th>
          <th>Best Fit Profile</th>
          <th onclick="sortAnalytics('best_fit_score')">Score${sortArrow('best_fit_score')}</th>
          <th onclick="sortAnalytics('engagement')">Engagement${sortArrow('engagement')}</th>
          <th>Details</th>
          <th>Reasoning</th>
          <th>Action</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;

      container.querySelectorAll('.analytics-add-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const platform = btn.dataset.platform;
          const endpoint = platform === 'youtube' ? `/api/yt/campaigns/${id}` : `/api/campaigns/${id}`;
          await fetch(endpoint, { method: 'PUT', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'not_contacted', notes: '' }) });
          campaignStatuses[id] = 'not_contacted';
          renderAnalyticsTable();
        });
      });
    }

    function toggleScoreRow(btn, idx) {
      const row = document.getElementById('score-row-' + idx);
      row.classList.toggle('open');
      btn.textContent = row.classList.contains('open') ? 'Hide' : 'Scores';
    }

    function sortAnalytics(field) {
      if (analyticsSortField === field) analyticsSortDir = analyticsSortDir === 'asc' ? 'desc' : 'asc';
      else { analyticsSortField = field; analyticsSortDir = field === 'creator_name' ? 'asc' : 'desc'; }
      renderAnalyticsTable();
    }

    async function triggerAnalysis() {
      const btn = document.getElementById('run-analysis-btn');
      const progress = document.getElementById('analysis-progress');
      btn.disabled = true; btn.textContent = 'Analyzing...';
      progress.textContent = 'Sending creators to GPT-4o-mini for scoring...';
      try {
        const res = await fetch('/api/analysis/run', { method: 'POST' });
        const data = await res.json();
        if (data.error) progress.textContent = 'Error: ' + data.error;
        else { progress.textContent = `Done! Analyzed ${data.analyzed_count} creators in ${(data.duration_ms / 1000).toFixed(1)}s`; await loadAnalysisResults(); }
      } catch (e) { progress.textContent = 'Error: ' + e.message; }
      finally { btn.disabled = false; btn.textContent = 'Run Analysis'; }
    }

    async function clearAndRerun() {
      if (!confirm('Clear all analysis results and re-run?')) return;
      await fetch('/api/analysis/results', { method: 'DELETE' });
      analysisResults = [];
      document.getElementById('analytics-summary').innerHTML = '';
      renderAnalyticsTable();
      await triggerAnalysis();
    }

    // ========== TABS ==========
    document.getElementById('search').addEventListener('input', render);
    document.getElementById('sort').addEventListener('change', render);
    document.getElementById('platform-filter').addEventListener('change', () => {
      activePlatformFilter = document.getElementById('platform-filter').value;
      activeTierFilter = 'all';
      activeNicheFilter = 'all';
      renderStats();
      renderFilterChips();
      render();
      updateReach();
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'campaigns') loadCampaigns();
        if (tab.dataset.tab === 'analytics') { loadIdealProfiles(); loadAnalysisResults(); }
      });
    });

    // ========== INIT ==========
    async function init() {
      const [igCreators, ytCreators, igCampaigns, ytCampaigns] = await Promise.all([
        fetch('/api/creators').then(r => r.json()),
        fetch('/api/yt/creators').then(r => r.json()),
        fetch('/api/campaigns').then(r => r.json()),
        fetch('/api/yt/campaigns').then(r => r.json()),
      ]);

      allCreators = [
        ...igCreators.map(normalizeIgCreator),
        ...ytCreators.map(normalizeYtCreator),
      ];

      campaignStatuses = {};
      igCampaigns.forEach(c => { campaignStatuses[c.username] = c.status; });
      ytCampaigns.forEach(c => { campaignStatuses[c.channel_id] = c.status; });

      renderSortOptions();
      renderStats();
      renderFilterChips();
      render();
      renderMethodology();
      updateReach();
    }

    init();
  </script>
</body>
</html>
